name: Deploy

on:
  push:
    branches: ["master"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: ⚡ Setup Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          export PATH="$HOME/.bun/bin:$PATH"
          bun --version

      - name: 📦 Install Dependencies
        run: bun install

      - name: 🔍 Ensure ESLint is Installed
        run: bun add -d eslint

      - name: 🧪 Run Tests
        run: bun test

      - name: ✨ Run ESLint Check
        id: eslint
        run: |
          echo "🔍 Linting the codebase..."
          npx eslint src --ext .js

      - name: ❌ Block Deploy if Lint Fails (Suggest Fix)
        if: failure()
        run: |
          echo "🚫 Lint check failed."
          echo "💡 Corrige les erreurs en local avec :"
          echo "    bun run lint:fix"
          exit 1

      - name: 🚀 SSH Deploy to VPS
        if: success()
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ~/Ourmusic
            git pull origin master
            echo "📦 Rebuilding Docker backend image"
            docker compose stop backend || true
            docker compose rm -f backend || true
            docker compose build backend
            echo "🔁 Restarting backend container"
            docker compose up -d backend
