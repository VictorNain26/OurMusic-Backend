name: Deploy

on:
  push:
    branches: ['master']

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: âš¡ Setup Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH
          export PATH="$HOME/.bun/bin:$PATH"
          bun --version

      - name: ğŸ“¦ Install Dependencies
        run: bun install

      - name: ğŸ” Ensure ESLint is Installed
        run: bun add -d eslint

      - name: ğŸ§ª Run Tests
        run: bun test

      - name: âœ¨ Run ESLint Check (Fails on Error)
        run: |
          echo "ğŸ” Running ESLint..."
          npx eslint src --ext .js || {
            echo "ğŸš« ESLint a dÃ©tectÃ© des erreurs.";
            echo "ğŸ’¡ Corrige-les en local avec : bun run lint:fix";
            exit 1;
          }

      - name: ğŸš€ SSH Deploy to VPS
        if: success()
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ~/Ourmusic || { echo "âŒ Dossier ~/Ourmusic introuvable sur le VPS"; exit 1; }

            echo "ğŸ§¹ Nettoyage de l'Ã©tat local du dÃ©pÃ´t..."
            git reset --hard HEAD || { echo "âŒ Ã‰chec git reset"; exit 1; }
            git clean -fd || { echo "âŒ Ã‰chec git clean"; exit 1; }

            echo "ğŸ“¥ Pulling last version from Git"
            git fetch origin master || { echo "âŒ Ã‰chec git fetch"; exit 1; }
            git pull origin master || { echo "âŒ Ã‰chec git pull. Abandon du dÃ©ploiement."; exit 1; }

            echo "ğŸ“Œ Dernier commit sur le VPS :"
            git log -1

            echo "ğŸ“¦ Rebuilding Docker backend image"
            docker compose stop backend || true
            docker compose rm -f backend || true
            docker compose build backend

            echo "ğŸ” Restarting backend container"
            docker compose up -d backend
